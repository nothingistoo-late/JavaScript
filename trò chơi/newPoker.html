<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Texas Hold'em</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }

        .card-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }

        .card {
            width: 50px;
            height: 75px;
            border: 1px solid black;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .button-container {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>Poker Texas Hold'em</h1>
    <div>
        <h2>Your Hand</h2>
        <div class="card-container" id="player-hand"></div>
    </div>
    <div>
        <h2>AI Hand</h2>
        <div class="card-container" id="ai-hand"></div>
    </div>
    <div>
        <h2>Community Cards</h2>
        <div class="card-container" id="community-cards"></div>
    </div>
    <p id="win-rate">Win Rate: 0%</p>
    <p id="best-hand"></p>
    <p id="result"></p>
    <div class="button-container">
        <button id="deal-button" onclick="dealCards()">Next Phase</button>
        <button onclick="restartGame()">Play Again</button>
    </div>

    <script>
        const suits = ['♠', '♥', '♦', '♣'];
        const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        let deck = [];
        let playerHand = [];
        let aiHand = [];
        let communityCards = [];
        let phase = 0;

        function createDeck() {
            deck = [];
            for (let suit of suits) {
                for (let value of values) {
                    deck.push({ value, suit });
                }
            }
            deck.sort(() => Math.random() - 0.5);
        }

        function dealCards() {
            if (phase === 0) {
                playerHand = deck.splice(0, 2);
                aiHand = deck.splice(0, 2);
            } else if (phase == 1) {
                communityCards = deck.splice(0, 3);
            } else if (phase < 4) {
                communityCards.push(deck.shift());
            }
            phase++;
            updateDisplay();
            if (communityCards.length + 2 >= 5) {
                calculateWinRate();
            }

        }

        function updateDisplay() {
            document.getElementById("player-hand").innerHTML = playerHand.map(card => `<div class='card'>${card.value}${card.suit}</div>`).join('');
            document.getElementById("ai-hand").innerHTML = aiHand.map(card => `<div class='card'>${card.value}${card.suit}</div>`).join('');
            document.getElementById("community-cards").innerHTML = communityCards.map(card => `<div class='card'>${card.value}${card.suit}</div>`).join('');
        }

        function restartGame() {
            createDeck();
            playerHand = [];
            aiHand = [];
            communityCards = [];
            phase = 0;
            document.getElementById("win-rate").innerText = "Win Rate: 0%";
            document.getElementById("best-hand").innerText = "";
            document.getElementById("result").innerText = "";
            updateDisplay();
            dealCards();
        }
        createDeck();

        function getCardValues(cards) {

            const cardRankings = { "J": 11, "Q": 12, "K": 13, "A": 14 };

            return cards.map(card =>
                cardRankings[card.value] || Number(card.value) || 0
            );
        }
        function hasPair(cards) {
            let values = getCardValues(cards);
            let counts = {};

            for (let val of values) {
                counts[val] = (counts[val] || 0) + 1;
                if (counts[val] === 2) return true; // Nếu tìm thấy cặp thì dừng ngay
            }
            return false;
        }

        function hasTwoPair(cards) {
            let values = getCardValues(cards);
            let counts = values.reduce((acc, val) => {
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});
            return Object.values(counts).filter(count => count === 2).length === 2;
        }

        function hasThreeOfAKind(cards) {
            let values = getCardValues(cards);
            let counts = values.reduce((acc, val) => {
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});
            return Object.values(counts).includes(3);
        }

        function hasFlush(cards) {
            let suitCounts = cards.reduce((acc, card) => {
                acc[card.suit] = (acc[card.suit] || 0) + 1;
                return acc;
            }, {});
            return Object.values(suitCounts).some(count => count >= 5);
        }


        function hasStraight(cards) {
            let valuesMap = {
                '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8,
                '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13, 'A': 14
            };

            // Chuyển đổi giá trị quân bài sang số
            let values = cards.map(card => valuesMap[card.value]);

            // Loại bỏ trùng lặp và sắp xếp tăng dần
            values = [...new Set(values)].sort((a, b) => a - b);

            // Xử lý trường hợp sảnh A-2-3-4-5
            if (values.includes(14)) values.unshift(1);

            // Kiểm tra dãy 5 số liên tiếp
            for (let i = 0; i <= values.length - 5; i++) {
                if (values[i + 4] - values[i] === 4 &&
                    values[i + 1] - values[i] === 1 &&
                    values[i + 2] - values[i + 1] === 1 &&
                    values[i + 3] - values[i + 2] === 1) {
                    return true;
                }
            }
            return false;
        }

        function hasFullHouse(cards) {
            let values = getCardValues(cards);
            let counts = values.reduce((acc, val) => {
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});

            let threeOfKind = Object.values(counts).includes(3);  // Có bộ ba
            let pair = Object.values(counts).includes(2);         // Có bộ đôi

            return threeOfKind && pair;  // Full House = 1 bộ ba + 1 bộ đôi
        }

        function hasFourOfAKind(cards) {
            let values = getCardValues(cards);
            let counts = values.reduce((acc, val) => {
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});
            return Object.values(counts).includes(4);
        }

        function hasStraightFlush(cards) {
            return hasFlush(cards) && hasStraight(cards);
        }

        function evaluateHand(cards) {
            if (hasStraightFlush(cards)) return { rank: 8, name: "Straight Flush" };
            if (hasFourOfAKind(cards)) return { rank: 7, name: "Four of a Kind" };
            if (hasFullHouse(cards)) return { rank: 6, name: "Full House" };
            if (hasFlush(cards)) return { rank: 5, name: "Flush" };
            if (hasStraight(cards)) return { rank: 4, name: "Straight" };
            if (hasThreeOfAKind(cards)) return { rank: 3, name: "Three of a Kind" };
            if (hasTwoPair(cards)) return { rank: 2, name: "Two Pair" };
            if (hasPair(cards)) return { rank: 1, name: "One Pair" };
            return { rank: 0, name: "High Card" };
        }

        function calculateWinRate() {
            var playerBestHand = [...playerHand, ...communityCards];
            const aiBestHand = [...aiHand, ...communityCards];

            var playerRank = evaluateHand(playerBestHand);
            var aiRank = evaluateHand(aiBestHand);

            console.log("player hand := " + playerBestHand.map(card => card.value + card.suit).join(", "));
            console.log("ai hand := " + aiBestHand.map(card => card.value + card.suit).join(", "));


            let winRate = 50;
            let resultText = "";

            if (playerRank.rank > aiRank.rank) {
                winRate = 100;
                resultText = `You Win with ${playerRank.name}!`;
            } else if (playerRank.rank < aiRank.rank) {
                winRate = 0;
                resultText = `AI Wins with ${aiRank.name}!`;
            } else {
                // Nếu cùng rank, so sánh giá trị bài
                // const comparison = compareHands(playerBestHand, aiBestHand);
                // if (comparison > 0) {
                //     winRate = 100;
                //     resultText = `You Win with ${playerBestHand.name}!`;
                // } else if (comparison < 0) {
                //     winRate = 0;
                //     resultText = `AI Wins with ${aiBestHand.name}!`;
                // } else {
                //     resultText = "It's a Tie!";
                // }
                winRate = 50;
                resultText = "Tie";
            }
            document.getElementById("win-rate").innerText = `Win Rate: ${winRate}%`;
            document.getElementById("best-hand").innerText = `Your Best Hand: ${playerRank.name} | AI Best Hand: ${aiRank.name}`;
            document.getElementById("result").innerText = resultText;
        }

    </script>
</body>